{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Таблица оценок участника</title>
    <link rel="stylesheet" href="{% static 'table/css/table.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.6.0/css/all.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
       body {
            background-color: #b7b7b7; /* Изменяем цвет фона страницы */
        }

    </style>
</head>
<body>
<header>
    <nav class="navbar">
        <ul class="navbar-menu">
            <li><a href="{% url 'main' %}"><i class="fa-solid fa-house"></i> Главная</a></li>
            <li><a href="{% url 'vote_page' %}"><i class="fa-solid fa-check"></i> Голосовать</a></li>
            <li><a href="{% url 'participant_scores' %}"><i class="fa-solid fa-table"></i> Таблица</a></li>
            <li><a href="#"><i class="fa-solid fa-star"></i> Рейтинг</a></li>
            <li class="logout"><a href="{% url 'signup' %}"><i class="fa-solid fa-right-from-bracket"></i> Выйти</a></li>
        </ul>
    </nav>
</header>
<div class="container mt-5">
    <h1>Оценки участника</h1>

    <form id="participantForm" method="post" class="mb-3">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Показать оценки</button>
    </form>

    <!-- Блок для сообщения об ошибке -->
    {% if error_message %}
        <div class="alert alert-danger" role="alert">
            {{ error_message }}
        </div>
    {% endif %}

    <!-- Блок для отображения участника и его оценок -->
    <div id="scoresContainer">
        {% if participant %}
            <h2 id="participant">Участник #{{ participant.number }}: {{ participant.name }}</h2>

            {% if scores %}
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Жюри</th>
                                <th>Техника</th>
                                <th>Композиция</th>
                                <th>Креативность</th>
                                <th>Впечатление</th>
                                <th>Средний балл</th>
                            </tr>
                        </thead>
                        <tbody id="scoresBody">
                            {% for score in scores %}
                                <tr>
                                    <td>{{ score.jury.username }}</td>
                                    <td>{{ score.technique }}</td>
                                    <td>{{ score.composition }}</td>
                                    <td>{{ score.creativity }}</td>
                                    <td>{{ score.impression }}</td>
                                    <td>{{ score.get_average_score|floatformat:2 }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Для этого участника пока нет оценок.</p>
            {% endif %}
        {% else %}
            <p>Выберите участника, чтобы увидеть его оценки.</p>
        {% endif %}
    </div>
</div>

<script>
    setInterval(function() {
    const participantId = "{{ participant.id|default:'' }}"; // Получаем ID участника из шаблона

    if (participantId) { // Убедитесь, что ID участника существует
        console.log("Отправляем запрос на обновление оценок для участника с ID:", participantId); // Лог для проверки выполнения

        $.ajax({
            url: "{% url 'get_scores' '0' %}".replace('0', participantId), // URL для получения оценок
            type: "GET",
            success: function(data) {
                console.log("Получены новые данные:", data); // Лог для проверки полученных данных
                // Обновляем таблицу оценок
                const scoresBody = $('#scoresBody');
                scoresBody.empty(); // Очищаем текущее содержимое таблицы

                if (data.length > 0) {
                    data.forEach(function(score) {
                        scoresBody.append(`
                            <tr>
                                <td>${score.jury}</td>
                                <td>${score.technique}</td>
                                <td>${score.composition}</td>
                                <td>${score.creativity}</td>
                                <td>${score.impression}</td>
                                <td>${score.average_score.toFixed(2)}</td>
                            </tr>
                        `);
                    });
                } else {
                    scoresBody.append('<tr><td colspan="6">Для этого участника пока нет оценок.</td></tr>');
                }
            },
            error: function(xhr, status, error) {
                console.error("Ошибка:", error);
            }
        });
    }
}, 5000); // Обновление каждые 5 секунд

</script>
</body>
</html>
